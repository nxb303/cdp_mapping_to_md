<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <title>JSON Mapping zu Markdown Tabelle</title>
    <script>
        function parseTransformations(transformations) {
            if (!transformations || transformations.length === 0) return "-";

            return transformations.map(t => {
                switch (t.type) {
                    case "StringToUpperTransformer": return "Uppercase";
                    case "StringToLowerTransformer": return "ToLowerCase";
                    case "TrimWhitespaceTransformer": return "TrimWhitespace";
                    case "StringToStringMappedTransformer":
                        return "Mapping (" + t.configuration.valueMap.map(v => `${v.key}→${v.value}`).join(", ") + ")";
                    case "BoolToStringMappedTransformer":
                        return `Bool→String (true='${t.configuration.trueValue}', false='${t.configuration.falseValue}')`;
                    default: return t.type;
                }
            }).join(" | ");
        }

        function extractMappings(props, prefix = "") {
            let result = [];

            for (let k in props) {
                let v = props[k];
                let targetField = prefix ? prefix + "." + k : k;

                if (v.valueProvider) {
                    let sourcePath = v.valueProvider.source.path || "-";
                    let transformations = parseTransformations(v.valueProvider.transformations);
                    result.push([sourcePath, targetField, transformations]);
                }

                if (v.multiValueProvider) {
                    v.multiValueProvider.providers.forEach(p => {
                        let sourcePath = p.valueProvider.source.path || "-";
                        let transformations = parseTransformations(p.valueProvider.transformations);
                        result.push([sourcePath, targetField, transformations]);
                    });
                }

                if (v.items && v.items.properties) {
                    result = result.concat(extractMappings(v.items.properties, targetField));
                }

                if (v.properties) {
                    result = result.concat(extractMappings(v.properties, targetField));
                }

                if (v.items && v.items.valueProvider) {
                    let sourcePath = v.items.valueProvider.source.path || "-";
                    let transformations = parseTransformations(v.items.valueProvider.transformations);
                    result.push([sourcePath, targetField, transformations]);
                }
            }

            return result;
        }

        function convertJsonToMarkdown() {
            let jsonInput = document.getElementById('jsonInput').value;
            let mappings;

            try {
                mappings = JSON.parse(jsonInput);
            } catch (error) {
                alert("Fehler beim Parsen der JSON-Datei: " + error);
                return;
            }

            let allResults = [];

            mappings.forEach(block => {
                if (block.mapping && block.mapping.properties) {
                    allResults = allResults.concat(extractMappings(block.mapping.properties));
                }
            });

            let markdown = "| Quellfeld (CDC) | Zielfeld (CDP) | Transformation |\n" +
                "|---|---|---|\n";

            allResults.forEach(row => {
                markdown += `| \\`${row[0]}\\` | \\`${row[1]}\\` | ${row[2]} |\n`;
            });

            document.getElementById('markdownOutput').value = markdown;
        }
    </script>
    <style>
        textarea { width: 100%; height: 200px; }
        button { margin-top: 10px; }
    </style>
</head>
<body>
    <h2>JSON Mapping zu Markdown Tabelle</h2>
    <textarea id="jsonInput" placeholder="JSON hier einfügen..."></textarea>
    <br>
    <button onclick="convertJsonToMarkdown()">Zu Markdown Tabelle konvertieren</button>
    <h3>Markdown Ergebnis:</h3>
    <textarea id="markdownOutput" placeholder="Markdown Tabelle erscheint hier..."></textarea>
</body>
</html>
